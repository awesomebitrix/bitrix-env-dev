# Введение

Заботливо собранный образ с предустановленным веб-окружением Битрикс и дополнительными возможностями.

С помощью него мы создадим полноценный виртуальный сервер для работы Битрикс-проекта.
Также доступны 
* php-отладчик xdebug
* ssh
* разные утилиты (htop, nano, mc)

Нацелен проект на разработчиков, которые хотят развернуть у себя песочницу на основе реального проекта.

## Организация работы с песочницей

Здесь я кратко изложу суть работы контейнеров и правильного взаимодействия с ними.

### Файлы проекта
Их мы будем складывать в особую папку, внутри которой овнер обязательно должен быть `bitrix:bitrix` (или же просто `600:600`).

В IDE мы будем править Git-репозиторий проекта. Синхронизировать файлы с песочницей мы будем через scp/ssh на контейнер. 
Так мы решим все проблемы с правами.

### Сеть и DNS

Мы не будем пробрасывать какие-либо порты контейнера на `localhost`, а будем обращаться к контейнеру напрямую.

Поэтому мы будем выставлять свои хостнеймы и айпишники каждому контейнеру. В этом нам поможет кастомная докер-сеть и наш `/etc/hosts`.

### База данных

Хоть веб-окружение Битрикс и предоставляет для работы mysql-сервер, нам удобнее использовать свой и в отдельном контейнере.

Почему? Стоит перезапустить контейнер с Битрикс-окружением и базой внутри через `docker run` и вы потеряете данные в базе.
Придется их заливать заново. Неприятно.

Еще мы вынесем директорию с данными mysql в хост-систему, чтоб они не терялись между перезапусками mysql-контейнера.

В работу возьмём официальный образ mysql:

https://hub.docker.com/_/mysql/

### Управление контейнерами

Скорее всего, в процессе работы, вам нужно будет перезапускать контейнер с нуля. И не один раз.

Постоянно выполнять команды `docker run`, `docker stop`, `docker rm` быстро надоест, поэтому мы вынесем этим команды в отдельные .sh-скрипты.

# Сборка и подготовка образов

### Сборка образа Bitrix

Что ж, я думаю вы насытились теоретической информацией и хотите перейти к практике.

Клонируем себе на машину исходники для сборки образа:

```bash
    $ mkdir ~/Docker
    $ cd ~/Docker
    $ git clone git@github.com:hybr1dmax/bitrix-env-dev.git
    $ cd bitrix-env-dev
```

Начинаем сборку образа по докерфайлу:

```bash
    $ docker build -t hybr1dmax/bitrix-env-dev . 
```
По-умолчанию, _1С Битрикс: Веб-окружение_ будет идти комплекте с php7.
Если вам требуется php5, укажите специальный параметр `IS_LEGACY_PHP=1`

```bash
    $ docker build --build-arg IS_LEGACY_PHP=1 -t hybr1dmax/bitrix-env-dev .
```

После этого образ для сайта готов.


### Подготовка образа MySQL

Берем официальный образ `mysql` себе:

```bash
    $ docker pull mysql

```

# Подготовка контейнеров

### Скрипт запуска для Bitrix-контейнера


Наш контейнер будем называть `project.local`, айпишник ему выставим `10.10.0.3`

Создаем для него скрипт запуска:
```bash
    $ touch bitrix_run.sh
```

Вставляем в него следующее содержимое:
```bash
    #!/bin/sh
    
    docker stop project.local;
    docker rm project.local;
    
    docker run -id \
    -h project.local \
    --name project.local \
    --net=my-docker-network --ip=10.10.0.3 \
    -e NOMYSQL=1 \
    -e BITRIX_SSH_PASS="bitrix_passphrase" \
    -e ROOT_SSH_PASS="root_passphrase" \
    -v ~/bitrix-project/files:/home/bitrix/www \
    hybr1dmax/bitrix-env-dev;
```

#### Подробнее о параметрах

`docker run` и `docker rm` уничтожают контейнер, если мы его уже запускали. 

Сам `docker run` содержит в себе множество аргументов; давайте разберемся в них:

* `-id` - запускаем контейнер как фоновый процесс
* `-h project.local`, `--name project.local` - красиво обзываем контейнер + выставляем внутренний хостнейм
* `--net=my-docker-network --ip=10.10.0.3` - подключаем контейнер к нашей кастомной докер-сети и выставляем контейнеру айпишник `10.10.0.2`
* `-e NOMYSQL=1` - если определен этот параметр, то в контейнере не будет конфигурироваться и запускаться встроенный mysql
* `-e BITRIX_SSH_PASS="bitrix_passphrase"` - определяем стандартный пароль к системному юзеру `bitrix`
* `-e ROOT_SSH_PASS="root_passphrase"` - определяем стандартный пароль к системному юзеру `root`
* `-v ~/bitrix-project/files:/home/bitrix/www` - монтируем папку с нашим проектом внутрь контейнера

Также доступны другие опции:

* `-e CYRILLIC_MODE=1` если ваш проект в кодировке `windows-1251`, то эта опция позволит указать соответствующие `mbstring.func_overload` и `mbstring.internal_encoding` в конфигах php


### Скрипт запуска для MySQL-контейнера

Создаем для него скрипт запуска:
```bash
    $ touch mysql_run.sh
```

Вставляем в него следующее содержимое:
```bash
    #!/bin/sh
    
    docker stop mysql.local;
    docker rm mysql.local;
    
    docker run -id \
    -h mysql.local \
    --name mysql.local \
    --net=my-docker-network --ip=10.10.0.2 \
    -e MYSQL_ROOT_PASSWORD='db-root-password' \
    -e MYSQL_USER='bitrix' \
    -e MYSQL_PASSWORD='db-bitrix-password' \
    -v /path/to/mysql-lib-dir:/var/lib/mysql \
    -v /etc/localtime:/etc/localtime:ro \
    mysql:5.5;
```

Вместо `/path/to/mysql-lib-dir` укажите путь до пустой папки, которую mysql наполнит своими данными и будет их использовать заново, если mysql-контейнер перезапускается с нуля..

### DNS

Чтобы с нашей рабочей машины обращаться к нашему контейнеру через доменное имя, а не через айпишник, добавим в свой `/etc/hosts` запись о хостнейме `project.local`:
```bash
    $ su
    # echo "10.10.0.2 project.local" >> /etc/hosts
```

Создадим свою docker-сеть:

```bash
    $ docker network create my-docker-network --subnet=10.10.0.0/16
```


### Доступы ssh

Если вы не укажете явно доступы к ssh, будут применены стандартные значения:

* `root` / `4EyahtMj`
* `bitrix` / `XW7ur3TB`


#### Многосайтовость

Раздел еще в разработке...


# Запуск контейнеров

```bash
    $ bash ./mysql_run.sh
    $ bash ./project_run.sh
```

После этого можно подключаться к нашему проекту через доменное имя _project.local_, а к базе - через _mysql.local_